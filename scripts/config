#!/bin/bash

#=================================================
# GENERIC STARTING
#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

ynh_abort_if_errors

#=================================================
# RETRIEVE ARGUMENTS
#=================================================

app=${YNH_APP_INSTANCE_NAME:-$YNH_APP_ID}
phpversion=$(ynh_app_setting_get --app=$app --key=phpversion)
current_fpm_footprint=$(ynh_app_setting_get --app=$app --key=fpm_footprint)

#=================================================
# SPECIFIC CODE
#=================================================
# LOAD VALUES
#=================================================

# Load the real value from the app config or elsewhere.
# Then get the value from the form.
# If the form has a value for a variable, take the value from the form,
# Otherwise, keep the value from the app config.

# with_sftp
old_with_sftp="$(ynh_app_setting_get --app=$app --key=with_sftp)"
with_sftp="${YNH_CONFIG_MAIN_SFTP_SFTP:-$old_with_sftp}"

# sftp password
is_password_exist=0
password=$(ynh_app_setting_get --app=$app --key=password)
if [ -n "$password" ]
then
    ynh_print_warn --message="A password already exist, it will not be replaced."
    # If a password already exist, unset the variable password and to not change it.
    unset password
    is_password_exist=1
else
    # Otherwise, get the new password
    password="$YNH_CONFIG_MAIN_SFTP_PASSWORD"
fi

#=================================================
# SHOW_CONFIG FUNCTION FOR 'SHOW' COMMAND
#=================================================

show_config() {
	# here you are supposed to read some config file/database/other then print the values
	# ynh_return "YNH_CONFIG_${PANEL_ID}_${SECTION_ID}_${OPTION_ID}=value"
	ynh_return "YNH_CONFIG_MAIN_SFTP_SFTP=$with_sftp"
    # ynh_return "YNH_CONFIG_MAIN_SFTP_PASSWORD=$password"

}

#=================================================
# MODIFY THE CONFIGURATION
#=================================================

ynh_app_config_apply() {
    _ynh_app_config_apply
    
    #=================================================
    # REMOVE OR ADD SFTP ACCESS
    #=================================================

    if [ "$with_sftp" != "$old_with_sftp" ]
    then
        yunohost app action run $app sftp --args with_sftp=$with_sftp

        # Change the password only if none was already set for the user
        if [ $is_password_exist -eq 0 ] && [ $with_sftp -eq 1 ]
        then
            # Add the password to the user
            chpasswd <<< "${app}:${password}"
            ynh_app_setting_set --app=$app --key=password --value="$password"
        fi
    fi
}

#=================================================
# SPECIFIC GETTERS FOR TOML SHORT KEY
#=================================================

get__fpm_footprint() {
    # Free footprint value for php-fpm
    # Check if current_fpm_footprint is an integer
    if [ "$current_fpm_footprint" -eq "$current_fpm_footprint" ] 2> /dev/null
    then
        echo "specific"
    else
        echo "$current_fpm_footprint"
    fi
}

get__free_footprint() {
    # Free footprint value for php-fpm
    # Check if current_fpm_footprint is an integer
    if [ "$current_fpm_footprint" -eq "$current_fpm_footprint" ] 2> /dev/null
    then
        # If current_fpm_footprint is an integer, that's a numeric value for the footprint
        echo "$current_fpm_footprint"
    else
        echo "0"
    fi
}

#=================================================
# SPECIFIC SETTERS FOR TOML SHORT KEYS
#=================================================

set__fpm_footprint() {
    if [ "$fpm_footprint" != "specific" ]
    then
        ynh_app_setting_set --app=$app --key=fpm_footprint --value="$fpm_footprint"
    fi
}

set__free_footprint() {
    if [ "$fpm_footprint" = "specific" ]
    then
        ynh_app_setting_set --app=$app --key=fpm_footprint --value="$free_footprint"
    fi
}

#=================================================
# GENERIC FINALIZATION
#=================================================

ynh_app_config_validate() {
    _ynh_app_config_validate

    if [ "${changed[fpm_usage]}" == "true" ] || [ "${changed[fpm_footprint]}" == "true" ] || [ "${changed[free_footprint]}" == "true" ]; then
        # If fpm_footprint is set to 'specific', use $free_footprint value.
        if [ "$fpm_footprint" = "specific" ]
        then
            fpm_footprint=$free_footprint
        fi

        if [ "$fpm_footprint" == "0" ]
        then
            ynh_print_err --message="When selecting 'specific', you have to set a footprint value into the field below."

            exit 0
        fi
    fi
}

ynh_app_config_apply() {
    _ynh_app_config_apply

    ynh_add_fpm_config --phpversion=$phpversion --usage=$fpm_usage --footprint=$fpm_footprint
}

ynh_app_config_run $1